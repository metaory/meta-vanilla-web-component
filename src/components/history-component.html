<template> </template>

<style>
:host {
  display: grid;
  text-align: center;
  height: 8rem;
  font-weight: 200;
  background: -webkit-linear-gradient(var(--dark-grey), var(--grey));
  background-clip: border-box;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
b {
  font-size: 1.1rem;
}
</style>

<script>
const MAX_STORAGE_LENGTH = 7
const SYMBOLS = { USD: '$', EUR: '&euro;', JPY: '&yen;' }
const STORAGE_KEY = 'currency-history'

const $history = document.querySelector('history-component')

const prependToDom = ({ srcAmount, srcSymbol, dstAmount, dstSymbol}) => {
  const div = document.createElement("div");
  div.innerHTML = `<b>${SYMBOLS[srcSymbol]}${srcAmount}</b>${srcSymbol} &#10093;
                   <b>${SYMBOLS[dstSymbol]}${dstAmount}</b>${dstSymbol}`
  $history.shadowRoot.prepend(div)
}

const fetchStorage = () => {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []
  }
  catch (err) {
    localStorage.removeItem(STORAGE_KEY)
    return []
  }
}

const addToStorage = (currencyProxy) => {
  const list = fetchStorage()
  list.unshift(currencyProxy)
  if (list.length > MAX_STORAGE_LENGTH) list.pop()
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list))
}

window.addEventListener('converted', (event) => {
  const { currencyProxy } = event.detail
  prependToDom(currencyProxy)
  addToStorage(currencyProxy)
})

setTimeout(() => fetchStorage().reverse().forEach(prependToDom), 0)

export default { name: 'history-component', }
</script>
